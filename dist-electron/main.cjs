"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("electron"),M=require("url"),w=require("path"),I=require("exceljs"),W=require("fs/promises"),L=require("fs");var O=typeof document<"u"?document.currentScript:null;function A(a){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const t in a)if(t!=="default"){const s=Object.getOwnPropertyDescriptor(a,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:()=>a[t]})}}return e.default=a,Object.freeze(e)}const R=A(w),S=A(W);async function H(a){try{let e=a;if(!e){const u=await l.dialog.showOpenDialog({title:"Importera personal fr√•n Excel",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile"]});if(u.canceled||!u.filePaths.length)return{success:!1,data:[],errors:["Import avbruten"]};e=u.filePaths[0]}console.log("üìñ Single file import - attempting structured parsing for:",e);const t=await b(e);if(t.success&&t.data.length>0)return console.log("‚úÖ Structured parsing successful, found",t.data.length,"staff members"),t;console.log("‚ö†Ô∏è Structured parsing failed, trying simple format...");const s=new I.Workbook;await s.xlsx.readFile(e);const n=s.getWorksheet(1);if(!n)return{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};const o=[],c=[];return n.eachRow((u,p)=>{if(p===1)return;const d=u.getCell(1).text?.trim(),f=u.getCell(2).text?.trim(),F=u.getCell(3).text?.trim()||"";if(!d){c.push(`Rad ${p}: Namn saknas`);return}if(!f){c.push(`Rad ${p}: Arbetstid saknas f√∂r ${d}`);return}o.push({name:d,workHours:f,comments:F})}),console.log("üìä Simple format parsing result:",{staffCount:o.length,errorsCount:c.length}),{success:o.length>0,data:o,errors:c.length>0?c:o.length===0?["Inga giltiga personalrader hittades"]:void 0}}catch(e){return console.error("üí• Single file import error:",e),{success:!1,data:[],errors:[`Import misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}async function j(){try{console.log("üöÄ Starting dual Excel import in main process...");const a=await l.dialog.showOpenDialog({title:"Importera OP- och ANE-filer (.xlsx)",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile","multiSelections"]});if(a.canceled||!a.filePaths.length)return console.log("‚ùå Import canceled by user"),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Import avbruten"]};if(a.filePaths.length!==2)return console.log("‚ùå Wrong number of files selected:",a.filePaths.length),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Ladda upp exakt 2 filer: en OP-fil och en ANE-fil"]};const e=a.filePaths.map(r=>({path:r,name:r.split("\\").pop()||r.split("/").pop()||"",type:B(r)})),t=e.find(r=>r.type==="OP"),s=e.find(r=>r.type==="ANE");if(!t||!s)return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:['Kunde inte identifiera OP- och ANE-filer. Kontrollera att filnamnen inneh√•ller "OP" respektive "ANE"']};console.log("üìÇ Reading files:"),console.log("  OP File:",t.path),console.log("  ANE File:",s.path);const[n,o]=await Promise.all([b(t.path),b(s.path)]);if(console.log("üìä File reading results:"),console.log("  OP Data:",{success:n.success,dataCount:n.data.length,errors:n.errors?.length||0}),console.log("  ANE Data:",{success:o.success,dataCount:o.data.length,errors:o.errors?.length||0}),!n.success||!o.success)return console.log("‚ùå One or both files failed to read"),{success:!1,week:"",opFileName:t.name,aneFileName:s.name,data:[],errors:[...(n.errors||[]).map(r=>`OP-fil: ${r}`),...(o.errors||[]).map(r=>`ANE-fil: ${r}`)]};console.log("üîó Combining staff data...");const c=[],u=[],p=n.data.map(r=>({...r,comments:r.comments?`[OP] ${r.comments}`:"[OP]"}));c.push(...p),console.log("‚úÖ Added OP staff:",p.length);const d=o.data.map(r=>({...r,comments:r.comments?`[ANE] ${r.comments}`:"[ANE]"}));c.push(...d),console.log("‚úÖ Added ANE staff:",d.length),console.log("üìà Combined totals:",{opStaff:p.length,aneStaff:d.length,totalStaff:c.length});const f=new Map;c.forEach(r=>{const h=r.name.match(/^(.+)\s+\((\w+)\)$/);if(h){const[,y,g]=h,k=`${y.toLowerCase()}-${g.toLowerCase()}`,E=r.comments.includes("[OP]")?"op":"ane";f.has(k)||f.set(k,{op:!1,ane:!1,count:0});const P=f.get(k);E==="op"&&(P.op=!0),E==="ane"&&(P.ane=!0),P.count++}}),f.forEach((r,h)=>{if(r.op&&r.ane&&r.count>1){const[y,g]=h.split("-");u.push(`Dublett hittad: "${y}" finns i b√•de OP- och ANE-filen f√∂r ${g}`)}});const F=D(t.name)||D(s.name);console.log("üìÖ Extracted week:",F);const i={success:!0,week:F,opFileName:t.name,aneFileName:s.name,data:c,warnings:u.length>0?u:void 0};return console.log("üéâ Final import result:",{success:i.success,week:i.week,opFileName:i.opFileName,aneFileName:i.aneFileName,dataCount:i.data.length,warningsCount:i.warnings?.length||0}),i}catch(a){return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:[`Import misslyckades: ${a instanceof Error?a.message:"Ok√§nt fel"}`]}}}async function b(a){try{console.log("üìñ Reading Excel file with structured parser:",a);const e=new I.Workbook;await e.xlsx.readFile(a);const t=e.getWorksheet(1);if(!t)return console.log("‚ùå Could not read worksheet"),{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};console.log("üìä Worksheet info:",{name:t.name,rowCount:t.rowCount,columnCount:t.columnCount});const s=[],n=[],c=a.toLowerCase().includes("ane"),u=c?2:3,p=3;let d=c?"ANE SSK":"OP SSK";console.log("üîç Detected file type:",c?"ANE":"OP","Header row:",u);const f=[];for(let i=p;i<p+5;i++){const h=t.getCell(u,i).value?.toString().trim()||"";console.log(`üìÖ Header col ${i}:`,h);const[y,g]=h.split(" ");f.push({col:i,name:y||"",date:g||""})}console.log("üìÜ Parsed weekdays:",f);let F=0;for(let i=u+1;i<=t.rowCount;i++){const h=t.getCell(i,2).value?.toString().trim();if(!h)continue;console.log(`üë§ Row ${i} - Name: "${h}"`);const y=h.toLowerCase();if(y.includes("usk")){d=c?"ANE USK":"OP USK",console.log("üîÑ Role changed to:",d);continue}if(["k√§k","antal","vakant"].some(g=>y.includes(g))){console.log("‚è≠Ô∏è Skipping system row:",h);continue}for(const{col:g,name:k,date:E}of f){const C=t.getCell(i,g).value?.toString().trim()||"",N=t.getCell(i+1,g).value?.toString().trim()||"";if(console.log(`  üìã ${k} (${E}): hours="${C}" comment="${N}"`),!C&&!N)continue;const _=[C,N].filter(Boolean).join(" - "),K=U(k);s.push({name:`${h} (${K})`,workHours:_||"Schemalagd",comments:`${d} - ${k} ${E}`}),F++}}return console.log("üìà Structured parse results:",{staffEntries:s.length,uniqueNames:new Set(s.map(i=>i.name)).size,errorsFound:n.length}),{success:!0,data:s,errors:n.length>0?n:void 0}}catch(e){return console.error("üí• Excel structured read error:",e),{success:!1,data:[],errors:[`Strukturerad l√§sning misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}function U(a){return{M√•n:"M√•ndag",Tis:"Tisdag",Ons:"Onsdag",Tor:"Torsdag",Fre:"Fredag",L√∂r:"L√∂rdag",S√∂n:"S√∂ndag"}[a]||a}function B(a){const e=a.toLowerCase();return e.includes("op")&&!e.includes("ane")?"OP":e.includes("ane")||e.includes("anestesi")?"ANE":"UNKNOWN"}function D(a){const e=a.toLowerCase().match(/(?:vecka|v|week)\.?(\d{1,2})/);if(e)return`v.${e[1]}`;const t=new Date;return`v.${Math.ceil((t.getTime()-new Date(t.getFullYear(),0,1).getTime())/(7*24*60*60*1e3))}`}async function V(a){try{const e=await l.dialog.showSaveDialog({title:"Exportera schema till Excel",defaultPath:"schema.xlsx",filters:[{name:"Excel-filer",extensions:["xlsx"]},{name:"Alla filer",extensions:["*"]}]});if(e.canceled||!e.filePath)return{success:!1,error:"Export avbruten"};const t=new I.Workbook,s=t.addWorksheet("Schema");return s.columns=[{header:"Dag",key:"day",width:15},{header:"Sal",key:"room",width:20},{header:"Pass",key:"pass",width:20},{header:"OP SSK",key:"opSSK",width:20},{header:"ANE SSK",key:"aneSSK",width:20},{header:"Korridor",key:"corridor",width:25}],a?.days&&a.days.forEach(n=>{n.operatingRooms&&n.operatingRooms.forEach(o=>{s.addRow({day:n.name||n.id,room:o.name,pass:o.pass?.name||"",opSSK:o.opSSK?.name||"",aneSSK:o.aneSSK?.name||""})}),n.corridorStaff&&n.corridorStaff.forEach(o=>{s.addRow({day:n.name||n.id,room:"",pass:"",opSSK:"",aneSSK:"",corridor:`${o.role}: ${o.staff?.name||""}`})})}),await t.xlsx.writeFile(e.filePath),{success:!0,filePath:e.filePath}}catch(e){return{success:!1,error:`Export misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`}}}class q{syncFilePath;lockFilePath;isWatching=!1;watcherCleanup;lastKnownHash="";clientId;constructor(){const e=R.dirname(l.app.getPath("exe"));this.syncFilePath=R.join(e,"schedule-sync.json"),this.lockFilePath=R.join(e,"schedule-sync.lock"),this.clientId=`client-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,this.setupIpcHandlers()}setupIpcHandlers(){l.ipcMain.handle("sync:init",async()=>{try{return await this.initializeSyncFile(),this.startWatching(),{success:!0,clientId:this.clientId}}catch(e){return console.error("Failed to initialize sync:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}),l.ipcMain.handle("sync:save",async(e,t)=>await this.saveSchedule(t.weeks)),l.ipcMain.handle("sync:load",async()=>await this.loadSchedule()),l.ipcMain.handle("sync:check-changes",async()=>await this.checkForChanges()),l.app.on("before-quit",()=>{this.stopWatching()})}async initializeSyncFile(){try{await S.access(this.syncFilePath)}catch{const e={version:1,lastModified:new Date().toISOString(),modifiedBy:this.clientId,weeks:[],hash:this.generateHash([])};await S.writeFile(this.syncFilePath,JSON.stringify(e,null,2)),this.lastKnownHash=e.hash}}async saveSchedule(e){let s=0;for(;s<3;)try{await this.waitForLockRelease(),await S.writeFile(this.lockFilePath,this.clientId);try{const n=await this.loadSyncFile();if(n.hash!==this.lastKnownHash&&n.modifiedBy!==this.clientId)return await this.releaseLock(),{success:!1,conflict:{local:e,remote:n.weeks,lastModified:n.lastModified,modifiedBy:n.modifiedBy}};const o=this.generateHash(e),c={version:n.version+1,lastModified:new Date().toISOString(),modifiedBy:this.clientId,weeks:e,hash:o};return await S.writeFile(this.syncFilePath,JSON.stringify(c,null,2)),this.lastKnownHash=o,await this.releaseLock(),{success:!0}}catch(n){throw await this.releaseLock(),n}}catch(n){if(s++,s>=3)return{success:!1,error:n instanceof Error?n.message:"Failed to save after multiple retries"};await new Promise(o=>setTimeout(o,100*s))}return{success:!1,error:"Maximum retries exceeded"}}async loadSchedule(){try{const e=await this.loadSyncFile();return this.lastKnownHash=e.hash,{success:!0,weeks:e.weeks}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to load schedule"}}}async checkForChanges(){try{const e=await this.loadSyncFile();return e.hash!==this.lastKnownHash&&e.modifiedBy!==this.clientId?(this.lastKnownHash=e.hash,{hasChanges:!0,weeks:e.weeks}):{hasChanges:!1}}catch(e){return console.error("Error checking for changes:",e),{hasChanges:!1}}}async loadSyncFile(){const e=await S.readFile(this.syncFilePath,"utf-8");return JSON.parse(e)}async waitForLockRelease(e=5e3){const t=Date.now();for(;Date.now()-t<e;)try{await S.access(this.lockFilePath),await new Promise(s=>setTimeout(s,50))}catch{return}try{await S.unlink(this.lockFilePath)}catch{}}async releaseLock(){try{await S.unlink(this.lockFilePath)}catch{}}generateHash(e){const t=JSON.stringify(e,null,0);let s=0;for(let n=0;n<t.length;n++){const o=t.charCodeAt(n);s=(s<<5)-s+o,s=s&s}return s.toString(36)}startWatching(){if(!this.isWatching)try{const e=L.watch(this.syncFilePath,{persistent:!1},t=>{if(t==="change"){const{BrowserWindow:s}=require("electron");s.getAllWindows().forEach(o=>{o.webContents.send("sync:file-changed")})}});this.watcherCleanup=()=>{typeof e.close=="function"&&e.close()},this.isWatching=!0}catch(e){console.error("Failed to start file watching:",e)}}stopWatching(){this.watcherCleanup&&(this.watcherCleanup(),this.watcherCleanup=void 0),this.isWatching=!1}}new q;const v=w.dirname(M.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:O&&O.tagName.toUpperCase()==="SCRIPT"&&O.src||new URL("main.cjs",document.baseURI).href));process.env.APP_ROOT=w.join(v,"..");const z=w.join(process.env.APP_ROOT,"dist-electron"),$=w.join(process.env.APP_ROOT,"dist"),x=process.env.VITE_DEV_SERVER_URL;process.env.VITE_PUBLIC=x?w.join(process.env.APP_ROOT,"public"):$;let m=null;function T(){m=new l.BrowserWindow({width:1920,height:1080,icon:w.join(process.env.VITE_PUBLIC||v,"icon.png"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:w.join(v,"preload.cjs")},fullscreen:!1,resizable:!0,minimizable:!0,maximizable:!0}),m.webContents.on("did-finish-load",()=>{m?.webContents.send("main-process-message",new Date().toLocaleString())}),x?(m.loadURL(x),m.webContents.openDevTools()):m.loadFile(w.join($,"index.html"))}l.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(l.app.quit(),m=null)});l.app.on("activate",()=>{l.BrowserWindow.getAllWindows().length===0&&T()});l.app.whenReady().then(T);l.ipcMain.handle("import-excel",async(a,e)=>await H(e));l.ipcMain.handle("import-dual-excel",async()=>await j());l.ipcMain.handle("export-excel",async(a,e)=>await V(e));l.ipcMain.handle("toggle-fullscreen",async()=>m?(m.setFullScreen(!m.isFullScreen()),m.isFullScreen()):!1);exports.MAIN_DIST=z;exports.RENDERER_DIST=$;exports.VITE_DEV_SERVER_URL=x;
