"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const u=require("electron"),_=require("url"),g=require("path"),F=require("exceljs");var P=typeof document<"u"?document.currentScript:null;async function I(n){try{let e=n;if(!e){const i=await u.dialog.showOpenDialog({title:"Importera personal fr√•n Excel",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile"]});if(i.canceled||!i.filePaths.length)return{success:!1,data:[],errors:["Import avbruten"]};e=i.filePaths[0]}const t=new F.Workbook;await t.xlsx.readFile(e);const l=t.getWorksheet(1);if(!l)return{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};const s=[],a=[];return l.eachRow((i,d)=>{if(d===1)return;const f=i.getCell(1).text?.trim(),p=i.getCell(2).text?.trim(),h=i.getCell(3).text?.trim()||"";if(!f){a.push(`Rad ${d}: Namn saknas`);return}if(!p){a.push(`Rad ${d}: Arbetstid saknas f√∂r ${f}`);return}s.push({name:f,workHours:p,comments:h})}),{success:!0,data:s,errors:a.length>0?a:void 0}}catch(e){return{success:!1,data:[],errors:[`Import misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}async function T(){try{console.log("üöÄ Starting dual Excel import in main process...");const n=await u.dialog.showOpenDialog({title:"Importera OP- och ANE-filer (.xlsx)",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile","multiSelections"]});if(n.canceled||!n.filePaths.length)return console.log("‚ùå Import canceled by user"),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Import avbruten"]};if(n.filePaths.length!==2)return console.log("‚ùå Wrong number of files selected:",n.filePaths.length),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Ladda upp exakt 2 filer: en OP-fil och en ANE-fil"]};const e=n.filePaths.map(o=>({path:o,name:o.split("\\").pop()||o.split("/").pop()||"",type:D(o)})),t=e.find(o=>o.type==="OP"),l=e.find(o=>o.type==="ANE");if(!t||!l)return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:['Kunde inte identifiera OP- och ANE-filer. Kontrollera att filnamnen inneh√•ller "OP" respektive "ANE"']};console.log("üìÇ Reading files:"),console.log("  OP File:",t.path),console.log("  ANE File:",l.path);const[s,a]=await Promise.all([b(t.path),b(l.path)]);if(console.log("üìä File reading results:"),console.log("  OP Data:",{success:s.success,dataCount:s.data.length,errors:s.errors?.length||0}),console.log("  ANE Data:",{success:a.success,dataCount:a.data.length,errors:a.errors?.length||0}),!s.success||!a.success)return console.log("‚ùå One or both files failed to read"),{success:!1,week:"",opFileName:t.name,aneFileName:l.name,data:[],errors:[...(s.errors||[]).map(o=>`OP-fil: ${o}`),...(a.errors||[]).map(o=>`ANE-fil: ${o}`)]};console.log("üîó Combining staff data...");const i=[],d=[],f=s.data.map(o=>({...o,comments:o.comments?`[OP] ${o.comments}`:"[OP]"}));i.push(...f),console.log("‚úÖ Added OP staff:",f.length);const p=a.data.map(o=>({...o,comments:o.comments?`[ANE] ${o.comments}`:"[ANE]"}));i.push(...p),console.log("‚úÖ Added ANE staff:",p.length),console.log("üìà Combined totals:",{opStaff:f.length,aneStaff:p.length,totalStaff:i.length});const h=new Map;i.forEach(o=>{const c=o.name.toLowerCase();h.set(c,(h.get(c)||0)+1)}),h.forEach((o,c)=>{o>1&&d.push(`Dublett hittad: "${c}" finns i b√•de OP- och ANE-filen`)});const S=A(t.name)||A(l.name);console.log("üìÖ Extracted week:",S);const r={success:!0,week:S,opFileName:t.name,aneFileName:l.name,data:i,warnings:d.length>0?d:void 0};return console.log("üéâ Final import result:",{success:r.success,week:r.week,opFileName:r.opFileName,aneFileName:r.aneFileName,dataCount:r.data.length,warningsCount:r.warnings?.length||0}),r}catch(n){return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:[`Import misslyckades: ${n instanceof Error?n.message:"Ok√§nt fel"}`]}}}async function b(n){try{console.log("üìñ Reading Excel file with structured parser:",n);const e=new F.Workbook;await e.xlsx.readFile(n);const t=e.getWorksheet(1);if(!t)return console.log("‚ùå Could not read worksheet"),{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};console.log("üìä Worksheet info:",{name:t.name,rowCount:t.rowCount,columnCount:t.columnCount});const l=[],s=[],i=n.toLowerCase().includes("ane"),d=i?2:3,f=3;let p=i?"ANE SSK":"OP SSK";console.log("üîç Detected file type:",i?"ANE":"OP","Header row:",d);const h=[];for(let r=f;r<f+5;r++){const c=t.getCell(d,r).value?.toString().trim()||"";console.log(`üìÖ Header col ${r}:`,c);const[k,w]=c.split(" ");h.push({col:r,name:k||"",date:w||""})}console.log("üìÜ Parsed weekdays:",h);let S=0;for(let r=d+1;r<=t.rowCount;r++){const c=t.getCell(r,2).value?.toString().trim();if(!c)continue;console.log(`üë§ Row ${r} - Name: "${c}"`);const k=c.toLowerCase();if(k.includes("usk")){p=i?"ANE USK":"OP USK",console.log("üîÑ Role changed to:",p);continue}if(["k√§k","antal","vakant"].some(w=>k.includes(w))){console.log("‚è≠Ô∏è Skipping system row:",c);continue}for(const{col:w,name:y,date:O}of h){const x=t.getCell(r,w).value?.toString().trim()||"",N=t.getCell(r+1,w).value?.toString().trim()||"";if(console.log(`  üìã ${y} (${O}): hours="${x}" comment="${N}"`),!x&&!N)continue;const $=[x,N].filter(Boolean).join(" - ");l.push({name:c,workHours:$||"Schemalagd",comments:`${p} - ${y} ${O}`}),S++}}return console.log("üìà Structured parse results:",{staffEntries:l.length,uniqueNames:new Set(l.map(r=>r.name)).size,errorsFound:s.length}),{success:!0,data:l,errors:s.length>0?s:void 0}}catch(e){return console.error("üí• Excel structured read error:",e),{success:!1,data:[],errors:[`Strukturerad l√§sning misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}function D(n){const e=n.toLowerCase();return e.includes("op")&&!e.includes("ane")?"OP":e.includes("ane")||e.includes("anestesi")?"ANE":"UNKNOWN"}function A(n){const e=n.toLowerCase().match(/(?:vecka|v|week)\.?(\d{1,2})/);if(e)return`v.${e[1]}`;const t=new Date;return`v.${Math.ceil((t.getTime()-new Date(t.getFullYear(),0,1).getTime())/(7*24*60*60*1e3))}`}async function K(n){try{const e=await u.dialog.showSaveDialog({title:"Exportera schema till Excel",defaultPath:"schema.xlsx",filters:[{name:"Excel-filer",extensions:["xlsx"]},{name:"Alla filer",extensions:["*"]}]});if(e.canceled||!e.filePath)return{success:!1,error:"Export avbruten"};const t=new F.Workbook,l=t.addWorksheet("Schema");return l.columns=[{header:"Dag",key:"day",width:15},{header:"Sal",key:"room",width:20},{header:"Pass",key:"pass",width:20},{header:"OP SSK",key:"opSSK",width:20},{header:"ANE SSK",key:"aneSSK",width:20},{header:"Korridor",key:"corridor",width:25}],n?.days&&n.days.forEach(s=>{s.operatingRooms&&s.operatingRooms.forEach(a=>{l.addRow({day:s.name||s.id,room:a.name,pass:a.pass?.name||"",opSSK:a.opSSK?.name||"",aneSSK:a.aneSSK?.name||""})}),s.corridorStaff&&s.corridorStaff.forEach(a=>{l.addRow({day:s.name||s.id,room:"",pass:"",opSSK:"",aneSSK:"",corridor:`${a.role}: ${a.staff?.name||""}`})})}),await t.xlsx.writeFile(e.filePath),{success:!0,filePath:e.filePath}}catch(e){return{success:!1,error:`Export misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`}}}const C=g.dirname(_.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:P&&P.tagName.toUpperCase()==="SCRIPT"&&P.src||new URL("main.cjs",document.baseURI).href));process.env.APP_ROOT=g.join(C,"..");const L=g.join(process.env.APP_ROOT,"dist-electron"),R=g.join(process.env.APP_ROOT,"dist"),E=process.env.VITE_DEV_SERVER_URL;process.env.VITE_PUBLIC=E?g.join(process.env.APP_ROOT,"public"):R;let m=null;function v(){m=new u.BrowserWindow({width:1920,height:1080,icon:g.join(process.env.VITE_PUBLIC||C,"icon.png"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:g.join(C,"preload.cjs")},fullscreen:!1,resizable:!0,minimizable:!0,maximizable:!0}),m.webContents.on("did-finish-load",()=>{m?.webContents.send("main-process-message",new Date().toLocaleString())}),E?(m.loadURL(E),m.webContents.openDevTools()):m.loadFile(g.join(R,"index.html"))}u.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(u.app.quit(),m=null)});u.app.on("activate",()=>{u.BrowserWindow.getAllWindows().length===0&&v()});u.app.whenReady().then(v);u.ipcMain.handle("import-excel",async(n,e)=>await I(e));u.ipcMain.handle("import-dual-excel",async()=>await T());u.ipcMain.handle("export-excel",async(n,e)=>await K(e));u.ipcMain.handle("toggle-fullscreen",async()=>m?(m.setFullScreen(!m.isFullScreen()),m.isFullScreen()):!1);exports.MAIN_DIST=L;exports.RENDERER_DIST=R;exports.VITE_DEV_SERVER_URL=E;
