"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("electron"),I=require("url"),S=require("path"),b=require("exceljs");var F=typeof document<"u"?document.currentScript:null;async function D(n){try{let e=n;if(!e){const c=await d.dialog.showOpenDialog({title:"Importera personal fr√•n Excel",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile"]});if(c.canceled||!c.filePaths.length)return{success:!1,data:[],errors:["Import avbruten"]};e=c.filePaths[0]}console.log("üìñ Single file import - attempting structured parsing for:",e);const t=await R(e);if(t.success&&t.data.length>0)return console.log("‚úÖ Structured parsing successful, found",t.data.length,"staff members"),t;console.log("‚ö†Ô∏è Structured parsing failed, trying simple format...");const l=new b.Workbook;await l.xlsx.readFile(e);const s=l.getWorksheet(1);if(!s)return{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};const a=[],i=[];return s.eachRow((c,g)=>{if(g===1)return;const m=c.getCell(1).text?.trim(),f=c.getCell(2).text?.trim(),E=c.getCell(3).text?.trim()||"";if(!m){i.push(`Rad ${g}: Namn saknas`);return}if(!f){i.push(`Rad ${g}: Arbetstid saknas f√∂r ${m}`);return}a.push({name:m,workHours:f,comments:E})}),console.log("üìä Simple format parsing result:",{staffCount:a.length,errorsCount:i.length}),{success:a.length>0,data:a,errors:i.length>0?i:a.length===0?["Inga giltiga personalrader hittades"]:void 0}}catch(e){return console.error("üí• Single file import error:",e),{success:!1,data:[],errors:[`Import misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}async function K(){try{console.log("üöÄ Starting dual Excel import in main process...");const n=await d.dialog.showOpenDialog({title:"Importera OP- och ANE-filer (.xlsx)",filters:[{name:"Excel-filer",extensions:["xlsx","xls"]},{name:"Alla filer",extensions:["*"]}],properties:["openFile","multiSelections"]});if(n.canceled||!n.filePaths.length)return console.log("‚ùå Import canceled by user"),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Import avbruten"]};if(n.filePaths.length!==2)return console.log("‚ùå Wrong number of files selected:",n.filePaths.length),{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:["Ladda upp exakt 2 filer: en OP-fil och en ANE-fil"]};const e=n.filePaths.map(o=>({path:o,name:o.split("\\").pop()||o.split("/").pop()||"",type:M(o)})),t=e.find(o=>o.type==="OP"),l=e.find(o=>o.type==="ANE");if(!t||!l)return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:['Kunde inte identifiera OP- och ANE-filer. Kontrollera att filnamnen inneh√•ller "OP" respektive "ANE"']};console.log("üìÇ Reading files:"),console.log("  OP File:",t.path),console.log("  ANE File:",l.path);const[s,a]=await Promise.all([R(t.path),R(l.path)]);if(console.log("üìä File reading results:"),console.log("  OP Data:",{success:s.success,dataCount:s.data.length,errors:s.errors?.length||0}),console.log("  ANE Data:",{success:a.success,dataCount:a.data.length,errors:a.errors?.length||0}),!s.success||!a.success)return console.log("‚ùå One or both files failed to read"),{success:!1,week:"",opFileName:t.name,aneFileName:l.name,data:[],errors:[...(s.errors||[]).map(o=>`OP-fil: ${o}`),...(a.errors||[]).map(o=>`ANE-fil: ${o}`)]};console.log("üîó Combining staff data...");const i=[],c=[],g=s.data.map(o=>({...o,comments:o.comments?`[OP] ${o.comments}`:"[OP]"}));i.push(...g),console.log("‚úÖ Added OP staff:",g.length);const m=a.data.map(o=>({...o,comments:o.comments?`[ANE] ${o.comments}`:"[ANE]"}));i.push(...m),console.log("‚úÖ Added ANE staff:",m.length),console.log("üìà Combined totals:",{opStaff:g.length,aneStaff:m.length,totalStaff:i.length});const f=new Map;i.forEach(o=>{const u=o.name.match(/^(.+)\s+\((\w+)\)$/);if(u){const[,w,h]=u,k=`${w.toLowerCase()}-${h.toLowerCase()}`,x=o.comments.includes("[OP]")?"op":"ane";f.has(k)||f.set(k,{op:!1,ane:!1,count:0});const N=f.get(k);x==="op"&&(N.op=!0),x==="ane"&&(N.ane=!0),N.count++}}),f.forEach((o,u)=>{if(o.op&&o.ane&&o.count>1){const[w,h]=u.split("-");c.push(`Dublett hittad: "${w}" finns i b√•de OP- och ANE-filen f√∂r ${h}`)}});const E=A(t.name)||A(l.name);console.log("üìÖ Extracted week:",E);const r={success:!0,week:E,opFileName:t.name,aneFileName:l.name,data:i,warnings:c.length>0?c:void 0};return console.log("üéâ Final import result:",{success:r.success,week:r.week,opFileName:r.opFileName,aneFileName:r.aneFileName,dataCount:r.data.length,warningsCount:r.warnings?.length||0}),r}catch(n){return{success:!1,week:"",opFileName:"",aneFileName:"",data:[],errors:[`Import misslyckades: ${n instanceof Error?n.message:"Ok√§nt fel"}`]}}}async function R(n){try{console.log("üìñ Reading Excel file with structured parser:",n);const e=new b.Workbook;await e.xlsx.readFile(n);const t=e.getWorksheet(1);if(!t)return console.log("‚ùå Could not read worksheet"),{success:!1,data:[],errors:["Kunde inte l√§sa arbetsblad"]};console.log("üìä Worksheet info:",{name:t.name,rowCount:t.rowCount,columnCount:t.columnCount});const l=[],s=[],i=n.toLowerCase().includes("ane"),c=i?2:3,g=3;let m=i?"ANE SSK":"OP SSK";console.log("üîç Detected file type:",i?"ANE":"OP","Header row:",c);const f=[];for(let r=g;r<g+5;r++){const u=t.getCell(c,r).value?.toString().trim()||"";console.log(`üìÖ Header col ${r}:`,u);const[w,h]=u.split(" ");f.push({col:r,name:w||"",date:h||""})}console.log("üìÜ Parsed weekdays:",f);let E=0;for(let r=c+1;r<=t.rowCount;r++){const u=t.getCell(r,2).value?.toString().trim();if(!u)continue;console.log(`üë§ Row ${r} - Name: "${u}"`);const w=u.toLowerCase();if(w.includes("usk")){m=i?"ANE USK":"OP USK",console.log("üîÑ Role changed to:",m);continue}if(["k√§k","antal","vakant"].some(h=>w.includes(h))){console.log("‚è≠Ô∏è Skipping system row:",u);continue}for(const{col:h,name:k,date:x}of f){const y=t.getCell(r,h).value?.toString().trim()||"",C=t.getCell(r+1,h).value?.toString().trim()||"";if(console.log(`  üìã ${k} (${x}): hours="${y}" comment="${C}"`),!y&&!C)continue;const T=[y,C].filter(Boolean).join(" - "),_=L(k);l.push({name:`${u} (${_})`,workHours:T||"Schemalagd",comments:`${m} - ${k} ${x}`}),E++}}return console.log("üìà Structured parse results:",{staffEntries:l.length,uniqueNames:new Set(l.map(r=>r.name)).size,errorsFound:s.length}),{success:!0,data:l,errors:s.length>0?s:void 0}}catch(e){return console.error("üí• Excel structured read error:",e),{success:!1,data:[],errors:[`Strukturerad l√§sning misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`]}}}function L(n){return{M√•n:"M√•ndag",Tis:"Tisdag",Ons:"Onsdag",Tor:"Torsdag",Fre:"Fredag",L√∂r:"L√∂rdag",S√∂n:"S√∂ndag"}[n]||n}function M(n){const e=n.toLowerCase();return e.includes("op")&&!e.includes("ane")?"OP":e.includes("ane")||e.includes("anestesi")?"ANE":"UNKNOWN"}function A(n){const e=n.toLowerCase().match(/(?:vecka|v|week)\.?(\d{1,2})/);if(e)return`v.${e[1]}`;const t=new Date;return`v.${Math.ceil((t.getTime()-new Date(t.getFullYear(),0,1).getTime())/(7*24*60*60*1e3))}`}async function W(n){try{const e=await d.dialog.showSaveDialog({title:"Exportera schema till Excel",defaultPath:"schema.xlsx",filters:[{name:"Excel-filer",extensions:["xlsx"]},{name:"Alla filer",extensions:["*"]}]});if(e.canceled||!e.filePath)return{success:!1,error:"Export avbruten"};const t=new b.Workbook,l=t.addWorksheet("Schema");return l.columns=[{header:"Dag",key:"day",width:15},{header:"Sal",key:"room",width:20},{header:"Pass",key:"pass",width:20},{header:"OP SSK",key:"opSSK",width:20},{header:"ANE SSK",key:"aneSSK",width:20},{header:"Korridor",key:"corridor",width:25}],n?.days&&n.days.forEach(s=>{s.operatingRooms&&s.operatingRooms.forEach(a=>{l.addRow({day:s.name||s.id,room:a.name,pass:a.pass?.name||"",opSSK:a.opSSK?.name||"",aneSSK:a.aneSSK?.name||""})}),s.corridorStaff&&s.corridorStaff.forEach(a=>{l.addRow({day:s.name||s.id,room:"",pass:"",opSSK:"",aneSSK:"",corridor:`${a.role}: ${a.staff?.name||""}`})})}),await t.xlsx.writeFile(e.filePath),{success:!0,filePath:e.filePath}}catch(e){return{success:!1,error:`Export misslyckades: ${e instanceof Error?e.message:"Ok√§nt fel"}`}}}const O=S.dirname(I.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:F&&F.tagName.toUpperCase()==="SCRIPT"&&F.src||new URL("main.cjs",document.baseURI).href));process.env.APP_ROOT=S.join(O,"..");const U=S.join(process.env.APP_ROOT,"dist-electron"),$=S.join(process.env.APP_ROOT,"dist"),P=process.env.VITE_DEV_SERVER_URL;process.env.VITE_PUBLIC=P?S.join(process.env.APP_ROOT,"public"):$;let p=null;function v(){p=new d.BrowserWindow({width:1920,height:1080,icon:S.join(process.env.VITE_PUBLIC||O,"icon.png"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:S.join(O,"preload.cjs")},fullscreen:!1,resizable:!0,minimizable:!0,maximizable:!0}),p.webContents.on("did-finish-load",()=>{p?.webContents.send("main-process-message",new Date().toLocaleString())}),P?(p.loadURL(P),p.webContents.openDevTools()):p.loadFile(S.join($,"index.html"))}d.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(d.app.quit(),p=null)});d.app.on("activate",()=>{d.BrowserWindow.getAllWindows().length===0&&v()});d.app.whenReady().then(v);d.ipcMain.handle("import-excel",async(n,e)=>await D(e));d.ipcMain.handle("import-dual-excel",async()=>await K());d.ipcMain.handle("export-excel",async(n,e)=>await W(e));d.ipcMain.handle("toggle-fullscreen",async()=>p?(p.setFullScreen(!p.isFullScreen()),p.isFullScreen()):!1);exports.MAIN_DIST=U;exports.RENDERER_DIST=$;exports.VITE_DEV_SERVER_URL=P;
